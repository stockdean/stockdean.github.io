<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Make学习 | MyBlog</title><link rel="stylesheet" type="text/css" href="//fonts.neworld.org/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Make学习</h1><a id="logo" href="/.">MyBlog</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 主页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Make学习</h1><div class="post-meta"><a href="/2019/04/10/Make学习/#comments" class="comment-count"></a><p><span class="date">Apr 10, 2019</span><span><a href="/categories/linux/" class="category">Linux</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><hr>
<h2 id="Make学习"><a href="#Make学习" class="headerlink" title="Make学习"></a>Make学习</h2><h2 id="1-几个问题"><a href="#1-几个问题" class="headerlink" title="1. 几个问题"></a>1. 几个问题</h2><ol>
<li>为什么需要makefile？<br>自动化编译。<blockquote>
<p>因为makefile 关系到了整个工程的编译规则。一个工程中的源文件不计数，其按类型、功能、<br>模块分别放在若干个目录中，makefile 定义了一系列的规则来指定，哪些文件需要先编译，<br>哪些文件需要后编译，哪些文件需要重新编译，甚至于进行更复杂的功能操作，</p>
</blockquote>
</li>
<li>什么是make？<br>解释makefile中指令的命令工具。<h2 id="2-理解编译和链接"><a href="#2-理解编译和链接" class="headerlink" title="2. 理解编译和链接"></a>2. 理解编译和链接</h2>编译:xx.cc-&gt;xx.o<br>链接:把工程的所有的xx.o文件组合成可执行文件<br>.lib文件:windows下的.obj文件打包后的文件<br>.a文件:Linux下的.o文件打包后的文件(Archive file)</li>
</ol>
<h2 id="3-makefile介绍"><a href="#3-makefile介绍" class="headerlink" title="3. makefile介绍"></a>3. makefile介绍</h2><h3 id="3-1-makefile的规则"><a href="#3-1-makefile的规则" class="headerlink" title="3.1 makefile的规则"></a>3.1 makefile的规则</h3><p>规则</p>
<ol>
<li>如果工程没有编译过，所有的c文件都要被编译并连接</li>
<li>如果工程的某几个C文件被修改，那么只编译被修改的c文件，并链接目标程序。</li>
<li>如果工程头文件被修改，需要编译引用这几个头文件的c语言，并来链接目标程序。</li>
</ol>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">target ... :  prerequisites ... </span><br><span class="line">	command</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="section">target:目标文件(包括objectFile或者可执行文件，也可能是个label)</span></span><br><span class="line"><span class="section">prerequisites:要生成target所需要的文件或者目标。</span></span><br><span class="line"><span class="section">command:是make执行需要命令</span></span><br></pre></td></tr></table></figure>
<p>所以prerequisites中如果有一个以上的文件比target新，command的命令就会被执行。</p>
<p>下面是一个例子<br><img src="/2019/04/10/Make学习/1552313280228.png" alt="Alt text"></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">edit : main.o kbd.o command.o display.o \</span><br><span class="line">insert.o search.o files.o utils.o</span><br><span class="line">	cc -o edit main.o kbd.o command.o display.o \</span><br><span class="line">insert.o search.o files.o utils.o</span><br><span class="line"></span><br><span class="line">main.o : main.c defs.h</span><br><span class="line">	cc -c main.c</span><br><span class="line">kbd.o : kbd.c defs.h command.h</span><br><span class="line">	cc -c kbd.c</span><br><span class="line">command.o : command.c defs.h command.h</span><br><span class="line">	cc -c command.c</span><br><span class="line">display.o : display.c defs.h buffer.h</span><br><span class="line">	cc -c display.c</span><br><span class="line">insert.o : insert.c defs.h buffer.h</span><br><span class="line">	cc -c insert.c</span><br><span class="line">search.o : search.c defs.h buffer.h</span><br><span class="line">	cc -c search.c</span><br><span class="line">files.o : files.c defs.h buffer.h command.h</span><br><span class="line">	cc -c files.c </span><br><span class="line">utils.o : utils.c defs.h</span><br><span class="line">	cc -c utils.c</span><br><span class="line">clean :</span><br><span class="line">	rm edit main.o kbd.o command.o display.o \</span><br><span class="line">insert.o search.o files.o utils.o</span><br></pre></td></tr></table></figure>
<p>在定义好依赖关系后，后续的那一行定义了如何生成目标文件的操作系统命令，一定要<br>以一个 Tab 键作为开头。</p>
<h3 id="3-2-make如何工作"><a href="#3-2-make如何工作" class="headerlink" title="3.2 make如何工作"></a>3.2 make如何工作</h3><p>默认只输入make命令</p>
<ol>
<li>make会在当前目录找<code>&quot;Makefile&quot;</code>后者<code>&quot;makefile&quot;</code></li>
<li>如果找到，会找第一个target文件，并把这个文件作为最终的目标文件。</li>
<li>如果edit(上面的target文件)不存在或者后面.o文件修改时间&gt;target文件，会执行后面定义的command来重新生成target文件，</li>
<li>如果edit依赖的.o文件不存在，则根据后面的规则生成对应的.o文件。</li>
<li>如果你的.c和.h存在，则会生成.o最后生成edit。</li>
</ol>
<p>在找寻的过程中，如果出现错误，比如最后被依赖的文件找不到，那么make 就会直接退出，并报错，而对于所定义的命令的错误，或是编译不成功，make 根本不理。make 只管文件的依赖性，即，如果在我找了依赖关系之后，冒号后面的文件还是不在，那么对不起，我就不工作啦。 </p>
<p>clean这种命令可以通过<code>make clean</code>来执行。</p>
<h3 id="3-3-makefile中使用变量"><a href="#3-3-makefile中使用变量" class="headerlink" title="3.3 makefile中使用变量"></a>3.3 makefile中使用变量</h3><p>使用变量代表文件list<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">objects = main.o kbd.o command.o display.o \</span><br><span class="line">insert.o search.o files.o utils.o </span><br><span class="line"></span><br><span class="line"><span class="section">edit: <span class="variable">$(objects)</span></span></span><br><span class="line">	cc -o edit <span class="variable">$(objects)</span></span><br><span class="line"><span class="section">main.o: main.c defs.h</span></span><br><span class="line">	cc -c main.c</span><br><span class="line"><span class="section">kbd.o: kbd.c defs.h comman.h</span></span><br><span class="line">	cc -c kbd.c</span><br><span class="line">command.o : command.c defs.h command.h</span><br><span class="line">	cc -c command.c</span><br><span class="line">display.o : display.c defs.h buffer.h</span><br><span class="line">	cc -c display.c</span><br><span class="line">insert.o : insert.c defs.h buffer.h</span><br><span class="line">	cc -c insert.c</span><br><span class="line">search.o : search.c defs.h buffer.h</span><br><span class="line">	cc -c search.c</span><br><span class="line">files.o : files.c defs.h buffer.h command.h</span><br><span class="line">	cc -c files.c </span><br><span class="line">utils.o : utils.c defs.h</span><br><span class="line">	cc -c utils.c</span><br><span class="line">clean :</span><br><span class="line">	rm edit main.o kbd.o command.o display.o \</span><br><span class="line">insert.o search.o files.o utils.o</span><br></pre></td></tr></table></figure></p>
<h3 id="3-4-make自动推导"><a href="#3-4-make自动推导" class="headerlink" title="3.4 make自动推导"></a>3.4 make自动推导</h3><p>make有自动推导的能力，只要看到.o能推导需要的.c和命令<br>所以可以修改makefile文件只保留.h文件</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">objects = main.o kbd.o command.o display.o \</span><br><span class="line">insert.o search.o files.o utils.o </span><br><span class="line"><span class="section">edit: <span class="variable">$(objects)</span></span></span><br><span class="line">	cc -o <span class="variable">$(objects)</span></span><br><span class="line">main.o : defs.h</span><br><span class="line">kbd.o : defs.h command.h</span><br><span class="line">command.o : defs.h command.h</span><br><span class="line">display.o : defs.h buffer.h</span><br><span class="line">insert.o : defs.h buffer.h</span><br><span class="line">search.o : defs.h buffer.h</span><br><span class="line">files.o : defs.h buffer.h command.h</span><br><span class="line">utils.o : defs.h </span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>:clean   //make的"隐晦规则"。表示clean是个伪目标文件</span></span><br><span class="line"><span class="section">clean: </span></span><br><span class="line">	rm edit <span class="variable">$(objects)</span></span><br></pre></td></tr></table></figure>
<h3 id="3-5-更精简的风格"><a href="#3-5-更精简的风格" class="headerlink" title="3.5 更精简的风格"></a>3.5 更精简的风格</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">objects: main.o kbd.o command.o display.o \</span></span><br><span class="line">insert.o search.o files.o utils.o </span><br><span class="line"><span class="section">edit: <span class="variable">$(objects)</span></span></span><br><span class="line">	cc -o <span class="variable">$(objects)</span></span><br><span class="line"><span class="variable">$(objects)</span> : defs.o</span><br><span class="line">kbd.o command.o files.o: command.h</span><br><span class="line">display.o insert.o search.o: buffer.h</span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>:clean</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm edit <span class="variable">$(objects)</span></span><br></pre></td></tr></table></figure>
<h3 id="3-6-保持写clean的习惯"><a href="#3-6-保持写clean的习惯" class="headerlink" title="3.6 保持写clean的习惯"></a>3.6 保持写clean的习惯</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm edit <span class="variable">$(objects)</span></span><br><span class="line">或者</span><br><span class="line">.PHONY : clean</span><br><span class="line">	-rm edit <span class="variable">$(objects)</span><span class="comment"># 减号意味着出现问题也不会中断</span></span><br><span class="line">					   <span class="comment"># clean往往放在makefile的最后</span></span><br></pre></td></tr></table></figure>
<h2 id="4-Makefile总述"><a href="#4-Makefile总述" class="headerlink" title="4. Makefile总述"></a>4. Makefile总述</h2><h3 id="4-1-makefile组成"><a href="#4-1-makefile组成" class="headerlink" title="4.1 makefile组成"></a>4.1 makefile组成</h3><p>Makefile包含五个元素</p>
<ol>
<li>显示规则：明显指出要生成的文件，文件依赖和生成的命令</li>
<li>隐晦规则：通过自动推导得到的规则</li>
<li>变量定义</li>
<li>文件指示：包括<strong>引用其他Makefile</strong>(如同include)、根据某些情况<strong>制定Makefile的有效部分</strong>，像c语言的#if一样和<strong>定义一个多行命令</strong>。</li>
<li>注释:#字符注释，若要使用#则用#<blockquote>
<p>命令必须以tab开始</p>
</blockquote>
</li>
</ol>
<h3 id="4-2-Makefile文件名"><a href="#4-2-Makefile文件名" class="headerlink" title="4.2 Makefile文件名"></a>4.2 Makefile文件名</h3><p>make命令的寻找路径:<code>./GNUmakefile</code>–&gt;<code>./makefile</code>–&gt;<code>./Makefile</code><br>这几个名字里最好使用Makefile<br>如果使用其他文件名如下操作<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -f Make.Linux <span class="comment">#make.Linux为指定的makefile</span></span><br></pre></td></tr></table></figure></p>
<h3 id="4-3-引用其他的Makefile"><a href="#4-3-引用其他的Makefile" class="headerlink" title="4.3 引用其他的Makefile"></a>4.3 引用其他的Makefile</h3><p>使用include可以引用别的Makefile<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> &lt;filename&gt; </span><br><span class="line"><span class="comment"># 不能使用tab在include前面</span></span><br><span class="line"><span class="comment"># filename可以是当前shell的文件模式(包含路径和通配符)</span></span><br><span class="line">比如</span><br><span class="line"><span class="section">bar:e.mk f.mk</span></span><br><span class="line"><span class="keyword">include</span> foo.make *.mk <span class="variable">$(bar)</span></span><br></pre></td></tr></table></figure></p>
<p>如果make在当前目录没有找到include的文件，然后会按下面的情况寻找</p>
<ol>
<li>make -I或–include-dir，会去指定目录寻找</li>
<li>如果(/usr/include或/usr/local/bin)存在那么也会寻找</li>
<li>如果还是不行会报错，如果要避免则需要在include前加-</li>
</ol>
<h3 id="4-4-环境变量MAKEFILES"><a href="#4-4-环境变量MAKEFILES" class="headerlink" title="4.4 环境变量MAKEFILES"></a>4.4 环境变量MAKEFILES</h3><p>如果在环境中定义了环境变量MAKEFILES,那么会把这个变量中的值做一个类似于include的动作。这个变量中的值是其他的Makefile，用空格分割。<br><strong>建议不使用这个变量，影响太大。</strong></p>
<h3 id="4-5-make的工作方式"><a href="#4-5-make的工作方式" class="headerlink" title="4.5 make的工作方式"></a>4.5 make的工作方式</h3><ol>
<li>读入所有的Makefile</li>
<li>读入被include的其他Makefile</li>
<li>初始化文件中的变量</li>
<li>推导隐晦规则，并分析所有规则</li>
<li>为所有目标文件创建依赖关系链。</li>
<li>根据依赖关系，决定哪些要重新生成。</li>
<li>执行生成命令<br>1-5 为第一个阶段<br>如果变量被使用，make会把其展开在使用的位置，但不会完全马上展开。仅当依赖要使用在其内部展开。<br>6-7为第二阶段</li>
</ol>
<h2 id="5-书写规则"><a href="#5-书写规则" class="headerlink" title="5. 书写规则"></a>5. 书写规则</h2><p>规则包含依赖关系，和生成目标的方法。<br>Makefile中规则顺序很重要，因为Makefile只应该有一个最终目标。所以第一条规则中目标被确立为最终的目标。</p>
<h3 id="5-1-举例"><a href="#5-1-举例" class="headerlink" title="5.1 举例"></a>5.1 举例</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">foo.o:foo.c foo.h # foo模块</span></span><br><span class="line">	gcc -c -g foo.c</span><br></pre></td></tr></table></figure>
<h3 id="5-2-语法"><a href="#5-2-语法" class="headerlink" title="5.2 语法"></a>5.2 语法</h3><p>见前面的部分</p>
<h3 id="5-3-在规则中使用通配符"><a href="#5-3-在规则中使用通配符" class="headerlink" title="5.3 在规则中使用通配符"></a>5.3 在规则中使用通配符</h3><p>make 支持三个通配符：* ? […]<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -f *.o</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印机打印所有.c</span></span><br><span class="line"><span class="section">print: *.c</span></span><br><span class="line">	lpr -p <span class="variable">$?</span></span><br><span class="line">	touch print</span><br><span class="line"></span><br><span class="line">objects = *.o </span><br><span class="line"><span class="comment"># 变量中的*.o不展开</span></span><br><span class="line">objects := <span class="variable">$(<span class="built_in">wildcard</span> *.o)</span></span><br><span class="line"><span class="comment"># 这里的是展开的*.o</span></span><br></pre></td></tr></table></figure></p>
<h3 id="5-4-文件搜寻"><a href="#5-4-文件搜寻" class="headerlink" title="5.4 文件搜寻"></a>5.4 文件搜寻</h3><p>如果有大量源文件需要分类并存放在不同的目录中，所以在给文件加上路径让make自动寻找。<br><strong>特殊变量VPATH</strong><br>如果没有指明这个变量，make 只会在当前的目录中去找寻依赖文件和目标文件。如果定义了这个变量，那么，make就会在当当前目录找不到的情况下，到所指定的目录中去找寻文件了。<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VPATH = src:../headers</span><br></pre></td></tr></table></figure></p>
<p>上面的的定义指定两个目录，“src”和“../headers”，make 会按照这个顺序进行搜索。目录由“冒号”分隔。（当然，当前目录永远是最高优先搜索的地方）<br><strong>关键字vpath</strong><br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 三种用法</span></span><br><span class="line"><span class="keyword">vpath</span> &lt;pattern&gt; &lt;directories&gt;</span><br><span class="line"><span class="comment"># 符合pattern的文件指定搜索目录</span></span><br><span class="line"><span class="keyword">vpath</span> &lt;pattern&gt;</span><br><span class="line"><span class="comment"># 消除符合模式pattern的文件的搜索目录</span></span><br><span class="line"><span class="keyword">vpath</span></span><br><span class="line"><span class="comment"># 消除所有已被设置好了的文件搜索目录</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">vpath</span> %.h ../headers</span><br><span class="line"><span class="comment"># 要求make在../headers目录下搜索所有以.h结尾的文件。</span></span><br><span class="line"><span class="keyword">vpath</span> %.c foo</span><br><span class="line"><span class="keyword">vpath</span> % blish</span><br><span class="line"><span class="keyword">vpath</span> %.c bar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 表示.c结尾的文件，先在foo目录，然后是blish,最后是bar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">vpath</span> %.c foo:bar</span><br><span class="line"><span class="keyword">vpath</span> % blish</span><br><span class="line"></span><br><span class="line"><span class="comment"># 表示.c结尾的文件，先在foo目录，然后是bar目录，最后是blish</span></span><br></pre></td></tr></table></figure></p>
<h3 id="5-5-伪目标"><a href="#5-5-伪目标" class="headerlink" title="5.5 伪目标"></a>5.5 伪目标</h3><p>伪目标是标签不是文件。所以不能和文件重名。<br>为了避免重名，所以使用<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : clean</span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm *.o temp</span><br></pre></td></tr></table></figure></p>
<p>只要有这个声明只能通过<code>make clean</code>执行。<br>伪目标一般没有依赖的文件，但是也可以指定依赖的文件。通过一键生成多个目标文件。<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">all : prog1 prog2 prog3</span><br><span class="line">.PHONY : all</span><br><span class="line">prog1 : prog1.o utils.o</span><br><span class="line">	cc -o prog1 prog1.o utils.o</span><br><span class="line">prog2 : prog2.o</span><br><span class="line">	cc -o prog2 prog2.o</span><br><span class="line">prog3 : prog3.o sort.o utils.o</span><br><span class="line">	cc -o prog3 prog3.o sort.o utils.o </span><br><span class="line"><span class="comment"># make all 生成所有目标文件</span></span><br></pre></td></tr></table></figure></p>
<p>伪目标也可以成为依赖<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : cleanall cleanobj cleandiff</span><br><span class="line">cleanall : cleanobj cleandiff</span><br><span class="line">	rm program</span><br><span class="line">cleanobj : </span><br><span class="line">	rm *.o</span><br><span class="line">cleandiff :</span><br><span class="line">	rm *.diff</span><br></pre></td></tr></table></figure></p>
<h3 id="5-6-多目标"><a href="#5-6-多目标" class="headerlink" title="5.6 多目标"></a>5.6 多目标</h3><p>多个target可以依赖于一个文件，并且生成的命令大体相似。于是能把其合并。<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bigoutput littleoutput : text.g</span><br><span class="line">	generate text.g -<span class="variable">$(<span class="built_in">subst</span> output,,<span class="variable">$@</span>)</span> &gt; <span class="variable">$@</span></span><br><span class="line"><span class="comment">#  -$(subst output,,$@)中$表示执行一个Makefile函数，函数名subst,后面为参数。$@表示目标的集合。“$@”依次取出目标，并执于命令。</span></span><br></pre></td></tr></table></figure></p>
<p>等价于<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bigoutput : text.g</span><br><span class="line">	generate text.g -big &gt; bigoutput</span><br><span class="line">littleoutput : text.g</span><br><span class="line">	generate text.g -little &gt; littleoutput</span><br></pre></td></tr></table></figure></p>
<h3 id="5-7-静态模式"><a href="#5-7-静态模式" class="headerlink" title="5.7 静态模式"></a>5.7 静态模式</h3><p>静态模式可以更加容易地定义多目标的规则，可以让我们的规则变得更加的有弹性和灵<br>活 。<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 语法</span></span><br><span class="line">&lt;targets ...&gt;: &lt;target-pattern&gt;: &lt;prereq-patterns ...&gt;</span><br><span class="line">	&lt;commands&gt; </span><br><span class="line"><span class="comment"># targets 定义了一系列的目标文件，可以有通配符。是目标的一个集合</span></span><br><span class="line"><span class="comment"># target-parrtern 是指明了 targets 的模式，也就是的目标集模式。 </span></span><br><span class="line"><span class="comment"># prereq-parrterns 是目标的依赖模式，它对 target-parrtern 形成的模式再进行一次依赖目标的定义。 </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 举例</span></span><br><span class="line">objects = foo.o bar.o</span><br><span class="line">all : <span class="variable">$(objects)</span></span><br><span class="line"><span class="variable">$(objects)</span> : %.o:%.c</span><br><span class="line">	<span class="variable">$(CC)</span> -c <span class="variable">$(CFLAGS)</span> <span class="variable">$&lt;</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># $&lt; = 所有的依赖目标集（foo.c bar.c）</span></span><br><span class="line"><span class="comment"># $@ = 所有的目标集(foo.o bar.o)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 等价于下面的</span></span><br><span class="line">foo.o : foo.c</span><br><span class="line">	<span class="variable">$(CC)</span> -c <span class="variable">$(CFLAGS)</span> foo.c -o foo.o</span><br><span class="line">bar.o : bar.c</span><br><span class="line">	<span class="variable">$(CC)</span> -c <span class="variable">$(CFLAGS)</span> bar.c -o bar.o </span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面可以过滤部分文件</span></span><br><span class="line">files = foo.elc bar.o lose.o</span><br><span class="line"><span class="variable">$(<span class="built_in">filter</span> %.o,<span class="variable">$(files)</span>)</span> : %.o: %.c</span><br><span class="line">	<span class="variable">$(CC)</span> -c <span class="variable">$(CFLAGS)</span> <span class="variable">$&lt;</span> -o <span class="variable">$@</span></span><br><span class="line"><span class="variable">$(<span class="built_in">filter</span> %.elc,<span class="variable">$(files)</span>)</span>:%elc:%.el</span><br><span class="line">	emacs -f batch-byte-complie <span class="variable">$&lt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># filter函数可以过滤files里面不采用的文件，再进行模式推导。</span></span><br></pre></td></tr></table></figure></p>
<h3 id="5-8-自动生成依赖性"><a href="#5-8-自动生成依赖性" class="headerlink" title="5.8 自动生成依赖性"></a>5.8 自动生成依赖性</h3><p>cc编译器的-M选项:自动寻找源文件包含的头文件并生成依赖关系<br>如果使用GNU的编译器，需要使用-MM参数，否则会引入大量标准库的头文件。<br>例如<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">	cc -M main.c</span><br><span class="line"><span class="section">main.o: main.c defs.h</span></span><br><span class="line">	gcc -MM main.c</span><br><span class="line"><span class="section">main.o: main.c defs.h</span></span><br></pre></td></tr></table></figure></p>
<p>GNU建议把编译器自动生成的依赖存放在一个文件中,[.d]文件。<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有的.d依赖于.c</span></span><br><span class="line"><span class="section">%.d: %.c</span></span><br><span class="line">	@set -e; rm -f <span class="variable">$@</span>; \</span><br><span class="line"><span class="variable">$(CC)</span> -M <span class="variable">$(CPPFLAGS)</span> <span class="variable">$&lt;</span> &gt; <span class="variable">$@</span>.$$$$; \</span><br><span class="line">sed 's,\(<span class="variable">$*</span>\)\.o[ :]*,\1.o <span class="variable">$@</span> : ,g' &lt; <span class="variable">$@</span>.$$$$ &gt; <span class="variable">$@</span>; \</span><br><span class="line">rm -f <span class="variable">$@</span>.$$$$ </span><br><span class="line"></span><br><span class="line"><span class="comment"># 接下来我们把这个Makefile引入常用的Makefile</span></span><br><span class="line">sources = foo.c bar.c</span><br><span class="line"><span class="keyword">include</span> $(sources:.c=.d)</span><br><span class="line"><span class="comment"># .c=.d 是做一个替换，把变量中所有的.c字串替换成.d。</span></span><br></pre></td></tr></table></figure></p>
<h2 id="6-书写命令"><a href="#6-书写命令" class="headerlink" title="6. 书写命令"></a>6. 书写命令</h2><p>命令必须以Tab开头，以;隔开，shell解析make命令</p>
<h3 id="6-1-显示命令"><a href="#6-1-显示命令" class="headerlink" title="6.1 显示命令"></a>6.1 显示命令</h3><p>当我们在命令前添加@,命令不会显示出来。<br>如果make执行时，加入<code>-n</code>或<code>--just-print</code>,那么只打印命令但不执行。而<code>-s</code>或<code>--slient</code>是全面禁止命令显示。</p>
<h3 id="6-2-命令执行"><a href="#6-2-命令执行" class="headerlink" title="6.2 命令执行"></a>6.2 命令执行</h3><p>例如<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">exec:</span></span><br><span class="line">	cd /home/ubuntu; pwd</span><br></pre></td></tr></table></figure></p>
<h3 id="6-3-命令出错"><a href="#6-3-命令出错" class="headerlink" title="6.3 命令出错"></a>6.3 命令出错</h3><p>命令运行完，make会检查返回码，如果返回成功继续执行。如果某个命令错了就退出规则，并可能终止所有的规则。<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">clean:</span></span><br><span class="line">	-rm -f *.o</span><br><span class="line"><span class="comment"># 在命令前加-那么不管命令出不出错都认为成功。</span></span><br></pre></td></tr></table></figure></p>
<p>或者给make加-i或–ignore-errors参数。<br>make 的参数的是“-k”或是“–keep-going”，这个参数的意思是，如果某规则中的命令出错了，那么就终目该规则的执行，但继续执行其它规则。 </p>
<h3 id="6-4-嵌套执行make"><a href="#6-4-嵌套执行make" class="headerlink" title="6.4 嵌套执行make"></a>6.4 嵌套执行make</h3><p>对于大工程会把Makefile拆成多个模块的小Makefile，所有嵌套执行make会有利于我们Makefile更加简洁。<br>例如一个subdir,目录下有Makefile，指明编译规则。那么可以这么写总控Makefile<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">subsystem:</span></span><br><span class="line">	cd subdir &amp;&amp; <span class="variable">$(MAKE)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">subsystem</span><br><span class="line">	<span class="variable">$(MAKE)</span> -C subdir</span><br></pre></td></tr></table></figure></p>
</div><div class="tags"></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2019/04/13/Aurora Multi-Master 解读/" class="pre">Aurora Multi-Master 解读</a><a href="/2019/04/10/Shell编程/" class="next">Shell编程</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Make学习"><span class="toc-text">Make学习</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-几个问题"><span class="toc-text">1. 几个问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-理解编译和链接"><span class="toc-text">2. 理解编译和链接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-makefile介绍"><span class="toc-text">3. makefile介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-makefile的规则"><span class="toc-text">3.1 makefile的规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-make如何工作"><span class="toc-text">3.2 make如何工作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-makefile中使用变量"><span class="toc-text">3.3 makefile中使用变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-make自动推导"><span class="toc-text">3.4 make自动推导</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-更精简的风格"><span class="toc-text">3.5 更精简的风格</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-保持写clean的习惯"><span class="toc-text">3.6 保持写clean的习惯</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Makefile总述"><span class="toc-text">4. Makefile总述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-makefile组成"><span class="toc-text">4.1 makefile组成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-Makefile文件名"><span class="toc-text">4.2 Makefile文件名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-引用其他的Makefile"><span class="toc-text">4.3 引用其他的Makefile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-环境变量MAKEFILES"><span class="toc-text">4.4 环境变量MAKEFILES</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-make的工作方式"><span class="toc-text">4.5 make的工作方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-书写规则"><span class="toc-text">5. 书写规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-举例"><span class="toc-text">5.1 举例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-语法"><span class="toc-text">5.2 语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-在规则中使用通配符"><span class="toc-text">5.3 在规则中使用通配符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-文件搜寻"><span class="toc-text">5.4 文件搜寻</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-伪目标"><span class="toc-text">5.5 伪目标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-多目标"><span class="toc-text">5.6 多目标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7-静态模式"><span class="toc-text">5.7 静态模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-8-自动生成依赖性"><span class="toc-text">5.8 自动生成依赖性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-书写命令"><span class="toc-text">6. 书写命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-显示命令"><span class="toc-text">6.1 显示命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-命令执行"><span class="toc-text">6.2 命令执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-命令出错"><span class="toc-text">6.3 命令出错</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-嵌套执行make"><span class="toc-text">6.4 嵌套执行make</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/04/13/剑指offer刷题笔记（一）/">剑指offer刷题笔记（一）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/13/Socket编程/">Socket编程</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/13/Effective C++ Note/">Effective C++ Note</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/13/Aurora Multi-Master 解读/">Aurora Multi-Master 解读</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/10/Make学习/">Make学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/10/Shell编程/">Shell编程</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/10/CMAKE 学习/">CMAKE 学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/01/性能分析工具（三）——valgrind/">性能分析工具（三）——valgrind</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/01/性能分析工具（二）——perf/">性能分析工具（二）——perf</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/01/MysqlTuner使用/MysqlTuner使用/">MysqlTuner使用</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/cpp/">CPP</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/">Database</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">Linux</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Network/">Network</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/oj/">OJ</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/OS/">OS</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/性能分析/">性能分析</a><span class="category-list-count">4</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">订阅</a> |  <a href="/about/">关于</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">Stockdean Mu.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script></body></html>